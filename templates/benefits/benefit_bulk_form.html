{% extends "layout.html" %}
{% load crispy_forms_tags %}

{% block body %}
<div class="row">
  <div class="col-md-10 offset-md-1">

    <h3 class="fw-bold">{{ title }}</h3>
    <hr>

    <form method="post" novalidate>
      {% csrf_token %}

      <!-- ✅ hidden: short class seçimi Apply'a basınca POST ile gitsin -->
      <input type="hidden" name="short_class_action" id="id_short_class_action" value="">

      <div class="row">
        <div class="col-md-4 mb-3">
          {{ form.worker|as_crispy_field }}
        </div>
        <div class="col-md-2 mb-3">
          {{ form.year|as_crispy_field }}
        </div>

        <!-- Months block -->
        <div class="col-md-6 mb-3">
          <label class="form-label mb-1">{{ form.months.label }}</label>

          <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
            <span class="badge rounded-pill bg-primary-subtle text-primary">
              Selected: <span id="months-count">0</span>
            </span>

            <div class="btn-toolbar ms-auto" role="toolbar" aria-label="Months actions">
              <div class="btn-group btn-group-sm me-2 mb-1" role="group" aria-label="Select/Clear">
                <button type="button" class="btn btn-outline-primary" onclick="toggleMonths(true)">Select All</button>
                <button type="button" class="btn btn-outline-secondary" onclick="toggleMonths(false)">Clear</button>
              </div>
              <div class="btn-group btn-group-sm mb-1" role="group" aria-label="Quarters">
                <button type="button" class="btn btn-outline-primary" onclick="selectQuarter(1)">Q1</button>
                <button type="button" class="btn btn-outline-primary" onclick="selectQuarter(2)">Q2</button>
                <button type="button" class="btn btn-outline-primary" onclick="selectQuarter(3)">Q3</button>
                <button type="button" class="btn btn-outline-primary" onclick="selectQuarter(4)">Q4</button>
              </div>
            </div>
          </div>

          <div class="border rounded p-2 bg-white" style="max-height:220px; overflow:auto;">
            {{ form.months }}
          </div>

          <div class="form-check mt-2">
            {{ form.overwrite_existing }}
            <label class="form-check-label" for="{{ form.overwrite_existing.id_for_label }}">
              {{ form.overwrite_existing.label }}
            </label>
          </div>

          <!-- ✅ Short class seçimi artık "seç & kalsın" -->
          <div class="mt-3">
            <label class="form-label fw-semibold">Apply to Short Class Groups</label>

            <div class="d-flex flex-wrap gap-2 align-items-center">
              <button type="button"
                      class="btn btn-outline-primary btn-sm short-class-btn"
                      data-value="W">
                White
              </button>

              <button type="button"
                      class="btn btn-outline-info btn-sm short-class-btn"
                      data-value="B">
                Blue
              </button>

              <button type="button"
                      class="btn btn-outline-success btn-sm short-class-btn"
                      data-value="I">
                Intern
              </button>

              <button type="button"
                      class="btn btn-outline-secondary btn-sm ms-auto"
                      id="clear-short-class">
                Clear Short Class
              </button>
            </div>

            <small class="text-muted d-block mt-1">
              Select a short class first, then click <b>Apply</b> to run the bulk update.
            </small>
          </div>

        </div>
      </div>

      <!-- Amount fields -->
      <div class="row">
        <div class="col-md-3 mb-3">{{ form.aile_yakacak|as_crispy_field }}</div>
        <div class="col-md-3 mb-3">{{ form.erzak|as_crispy_field }}</div>
        <div class="col-md-3 mb-3">{{ form.altin|as_crispy_field }}</div>
        <div class="col-md-3 mb-3">{{ form.bayram|as_crispy_field }}</div>
      </div>

      <div class="row">
        <div class="col-md-3 mb-3">{{ form.dogum_evlenme|as_crispy_field }}</div>
        <div class="col-md-3 mb-3">{{ form.fon|as_crispy_field }}</div>
        <div class="col-md-3 mb-3">{{ form.harcirah|as_crispy_field }}</div>
        <div class="col-md-3 mb-3">{{ form.yol_parasi|as_crispy_field }}</div>
      </div>

      <div class="row">
        <div class="col-md-3 mb-3">{{ form.prim|as_crispy_field }}</div>
      </div>

      <div class="d-flex justify-content-end align-items-center gap-2 mt-3">
        <a href="{% url 'benefits:list' %}" class="btn btn-secondary">Cancel</a>
        <button type="submit" class="btn fw-semibold"
                style="--bs-btn-bg:#6f42c1; --bs-btn-border-color:#5a35a3; --bs-btn-color:#f2efff;
                    --bs-btn-hover-bg:#5b36a3; --bs-btn-hover-border-color:#4f2f92; --bs-btn-hover-color:#fff;
                    --bs-btn-focus-shadow-rgb:111,66,193;">
          Apply
        </button>
      </div>

    </form>

  </div>
</div>

<script>
  // Months checkboxlarını Bootstrap "chip" buton gibi göstermek (ek CSS yok)
  function enhanceMonthsUI() {
    const ul = document.getElementById('id_months');
    if (!ul) return;

    ul.classList.add('d-flex','flex-wrap','gap-2','list-unstyled','mb-0');

    ul.querySelectorAll('li').forEach(li => {
      li.classList.add('m-0');
      const label = li.querySelector('label');
      const cb = li.querySelector('input[type="checkbox"]');
      if (!label || !cb) return;

      label.classList.add('btn','btn-sm','btn-outline-primary');
      label.style.borderRadius = '50rem';
      label.style.userSelect = 'none';

      const sync = () => {
        if (cb.checked) {
          label.classList.remove('btn-outline-primary');
          label.classList.add('btn-primary');
        } else {
          label.classList.add('btn-outline-primary');
          label.classList.remove('btn-primary');
        }
      };
      cb.addEventListener('change', sync);
      sync();
    });
  }

  function monthCheckboxes(){ return document.querySelectorAll('input[name="months"]'); }
  function updateCount(){
    const n = document.querySelectorAll('input[name="months"]:checked').length;
    const el = document.getElementById('months-count');
    if (el) el.textContent = n;
  }
  function toggleMonths(check){
    monthCheckboxes().forEach(cb => { cb.checked = check; cb.dispatchEvent(new Event('change')); });
    updateCount();
  }
  function selectQuarter(q){
    const ranges = {1:[1,3],2:[4,6],3:[7,9],4:[10,12]};
    const [s,e] = ranges[q];
    monthCheckboxes().forEach(cb => {
      const m = parseInt(cb.value,10);
      cb.checked = (m >= s && m <= e);
      cb.dispatchEvent(new Event('change'));
    });
    updateCount();
  }

  // ✅ Short class seçimi: submit etme, sadece hidden'a yaz ve seçili göster
  function setupShortClassUI() {
    const hidden = document.getElementById('id_short_class_action');
    const workerSelect = document.getElementById('id_worker');
    const btns = document.querySelectorAll('.short-class-btn');
    const clearBtn = document.getElementById('clear-short-class');

    const setActive = (value) => {
      btns.forEach(b => {
        const v = b.getAttribute('data-value');
        const isActive = (v === value);

        // butonun kendi outline rengini bozmadan sadece "active" efekti verelim:
        b.classList.toggle('active', isActive);

        // bootstrap active hissi (arkaplan) için:
        if (isActive) {
          // outline -> filled
          if (b.classList.contains('btn-outline-primary')) { b.classList.add('btn-primary'); b.classList.remove('btn-outline-primary'); }
          if (b.classList.contains('btn-outline-info'))    { b.classList.add('btn-info');    b.classList.remove('btn-outline-info'); }
          if (b.classList.contains('btn-outline-success')) { b.classList.add('btn-success'); b.classList.remove('btn-outline-success'); }
        } else {
          // filled -> outline
          if (b.classList.contains('btn-primary')) { b.classList.add('btn-outline-primary'); b.classList.remove('btn-primary'); }
          if (b.classList.contains('btn-info'))    { b.classList.add('btn-outline-info');    b.classList.remove('btn-info'); }
          if (b.classList.contains('btn-success')) { b.classList.add('btn-outline-success'); b.classList.remove('btn-success'); }
        }
      });
    };

    btns.forEach(b => {
      b.addEventListener('click', () => {
        const value = b.getAttribute('data-value');
        hidden.value = value;
        setActive(value);

        // UX: short class seçilince worker opsiyonel olduğu için disable edelim
        if (workerSelect) {
          workerSelect.value = '';
          workerSelect.setAttribute('disabled', 'disabled');
        }
      });
    });

    clearBtn?.addEventListener('click', () => {
      hidden.value = '';
      setActive('');
      if (workerSelect) workerSelect.removeAttribute('disabled');
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    enhanceMonthsUI();
    monthCheckboxes().forEach(cb => cb.addEventListener('change', updateCount));
    updateCount();
    setupShortClassUI();
  });
function addThousandsTR(num) {
    num = num.replace(/\D/g, "");
    return num.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".tr-money").forEach(function (input) {

        /* -------- FOCUS -------- */
        // Input'a tıklanınca sadece "0" ise sil
        input.addEventListener("focus", function () {
            if (this.value === "0") {
                this.value = "";
            }
        });

        /* -------- INPUT (LIVE FORMAT) -------- */
        input.addEventListener("input", function () {
            let value = this.value;

            // sadece rakam ve virgül
            value = value.replace(/[^0-9,]/g, "");

            // birden fazla virgül varsa fazlasını at
            const parts = value.split(",");
            let intPart = parts[0] || "";
            let decPart = parts[1] || "";

            // decimal max 2 hane
            decPart = decPart.slice(0, 2);

            // integer kısmını formatla
            intPart = addThousandsTR(intPart);

            // virgül yazıldıysa koru
            if (value.includes(",")) {
                this.value = intPart + "," + decPart;
            } else {
                this.value = intPart;
            }
        });

        /* -------- BLUR -------- */
        input.addEventListener("blur", function () {
            let value = this.value.trim();

            if (value === "") {
                this.value = "0";
                return;
            }

            let [intPart, decPart] = value.split(",");

            intPart = addThousandsTR(intPart || "");

            this.value = decPart !== undefined
                ? `${intPart},${decPart}`
                : intPart;
        });
    });
});
</script>
{% endblock %}
