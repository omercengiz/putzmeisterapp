{% extends "layout.html" %}

{% block body %}
<div class="container py-5">
  <!-- Başlık + Sağ üstte toplu aç/kapat butonu -->
  <div class="d-flex justify-content-between align-items-center mb-5">
    <h3 class="mb-0">Lookup Management</h3>
    <button id="toggle-all" type="button" class="btn btn-outline-secondary btn-sm">
      Collapse all
    </button>
  </div>

  {% for block in forms_and_items %}
    <div class="card mb-4 border-0 shadow-sm rounded-3 bg-white">
      <div class="card-header bg-light d-flex justify-content-between align-items-center toggle-header"
           style="cursor: pointer; padding: 1rem 1.25rem;">
        <div class="fw-semibold text-dark">{{ block.name }}</div>
        <div class="toggle-icon fs-5 text-success">▼</div>
      </div>

      <div class="card-body d-none bg-white rounded-bottom-3" id="body-{{ block.name }}">
        <form method="post" class="row g-3 align-items-center mb-3">
          {% csrf_token %}
          <div class="col-md-10">
            {{ block.form.as_p }}
          </div>
          <div class="col-md-2 text-end">
            <input type="hidden" name="form_name" value="{{ block.name }}">
            <button type="submit" class="btn btn-success w-100">Add</button>
          </div>
        </form>

        {% if block.items %}
          <ul class="list-group">
            {% for item in block.items %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                {{ item }}
                <form method="post" action="{% url 'delete_lookup' block.model_name item.id %}" style="margin: 0;">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                </form>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted">There is no record</div>
        {% endif %}
      </div>
    </div>
  {% endfor %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const toggles = document.querySelectorAll('.toggle-header');
  const toggleAllBtn = document.getElementById('toggle-all');

  toggles.forEach(header => {
    const body = header.nextElementSibling;
    const icon = header.querySelector('.toggle-icon');

    // Varsayılan: hepsi kapalı
    body.classList.add('d-none');
    icon.textContent = '▼';

    header.addEventListener('click', () => {
      const isOpen = !body.classList.contains('d-none');
      body.classList.toggle('d-none');
      icon.textContent = isOpen ? '▼' : '▲';
    });
  });

  // Toplu aç/kapat
  function anyOpen() {
    return Array.from(toggles).some(h => !h.nextElementSibling.classList.contains('d-none'));
  }

  toggleAllBtn.addEventListener('click', () => {
    const shouldOpen = !anyOpen();
    toggles.forEach(header => {
      const body = header.nextElementSibling;
      const icon = header.querySelector('.toggle-icon');
      if (shouldOpen) {
        body.classList.remove('d-none');
        icon.textContent = '▲';
      } else {
        body.classList.add('d-none');
        icon.textContent = '▼';
      }
    });
    toggleAllBtn.textContent = shouldOpen ? 'Collapse all' : 'Expand all';
  });

  toggleAllBtn.textContent = 'Expand all';
});
</script>
{% endblock %}
