{% extends "layout.html" %}

{% block body %}
<div class="container py-5">
  <h3 class="mb-5">Lookup Yönetimi</h3>

  {% for block in forms_and_items %}
    <div class="card mb-4 border-0 shadow-sm rounded-3 bg-white">
      <div class="card-header bg-light d-flex justify-content-between align-items-center toggle-header" style="cursor: pointer; padding: 1rem 1.25rem;">
        <div class="fw-semibold text-dark">{{ block.name }}</div>
        <div class="toggle-icon fs-5 text-success">▼</div>
      </div>

      <div class="card-body d-none bg-white rounded-bottom-3" id="body-{{ block.name }}">
        <form method="post" class="row g-3 align-items-center mb-3">
          {% csrf_token %}
          <div class="col-md-10">
            {{ block.form.as_p }}
          </div>
          <div class="col-md-2 text-end">
            <input type="hidden" name="form_name" value="{{ block.name }}">
            <button type="submit" class="btn btn-success w-100">Ekle</button>
          </div>
        </form>

        {% if block.items %}
          <ul class="list-group">
            {% for item in block.items %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                {{ item }}
                <form method="post" action="{% url 'delete_lookup' block.model_name item.id %}" style="margin: 0;">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-outline-danger">Sil</button>
                </form>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted">Henüz kayıt yok.</div>
        {% endif %}
      </div>
    </div>
  {% endfor %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const toggles = document.querySelectorAll('.toggle-header');

    toggles.forEach(header => {
      const body = header.nextElementSibling;
      const icon = header.querySelector('.toggle-icon');
      const blockName = body.id.replace('body-', '');

      // Sayfa yüklendiğinde accordion açık mı kontrol et
      const isOpenStored = localStorage.getItem('accordion_' + blockName) === 'true';
      if (isOpenStored) {
        body.classList.remove('d-none');
        icon.textContent = '▲';
      }

      // Tıklanınca accordion'u aç/kapat ve durumu kaydet
      header.addEventListener('click', () => {
        const isOpen = !body.classList.contains('d-none');
        body.classList.toggle('d-none');
        icon.textContent = isOpen ? '▼' : '▲';
        localStorage.setItem('accordion_' + blockName, !isOpen);
      });
    });
  });
</script>
{% endblock %}
