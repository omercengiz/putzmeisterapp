{% extends "layout.html" %}

{% block body %}
<div class="container py-5">
  <div class="d-flex justify-content-between align-items-center mb-5">
    <h3 class="mb-0">Lookup Management</h3>
    <button id="toggle-all" type="button" class="btn btn-outline-secondary btn-sm">
      Collapse all
    </button>
  </div>

  {% for block in forms_and_items %}
    <div class="card mb-4 border-0 shadow-sm rounded-3 bg-white">
      <div class="card-header bg-light d-flex justify-content-between align-items-center toggle-header"
           style="cursor: pointer; padding: 1rem 1.25rem;"
           data-section="{{ block.name }}">
        <div class="fw-semibold text-dark">{{ block.name }}</div>
        <div class="toggle-icon fs-5 text-success">▼</div>
      </div>

      <div class="card-body d-none bg-white rounded-bottom-3" id="body-{{ block.name }}">
        <!-- Add Form -->
        <form method="post" class="row g-3 align-items-center mb-3">
          {% csrf_token %}
          <div class="col-md-10">
            {{ block.form.as_p }}
          </div>
          <div class="col-md-2 text-end">
            <input type="hidden" name="form_name" value="{{ block.name }}">
            <button type="submit" class="btn btn-success w-100">Add</button>
          </div>
        </form>

        <!-- Items -->
        {% if block.items %}
          <ul class="list-group">
            {% for item in block.items %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>{{ item }}</span>

                <div class="d-flex align-items-center gap-2 m-0">
                  <!-- EDIT (modal) -->
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-warning open-edit-modal"
                    data-bs-toggle="modal"
                    data-bs-target="#editLookupModal"
                    data-update-url="{% url 'update_lookup' block.model_name item.id %}"
                    data-prefix="{{ block.model_name }}"
                    data-field1="{% if block.model_name == 'CostCenter' %}code{% else %}{% for f in block.form %}{% if not f.is_hidden %}{% if forloop.first %}{{ f.name }}{% endif %}{% endif %}{% endfor %}{% endif %}"
                    data-field2="{% if block.model_name == 'CostCenter' %}name{% else %}{% endif %}"
                    data-value1="{% if block.model_name == 'CostCenter' %}{{ item.code }}{% else %}{{ item }}{% endif %}"
                    data-value2="{% if block.model_name == 'CostCenter' %}{{ item.name }}{% else %}{% endif %}">
                    Edit
                  </button>

                  <!-- DELETE -->
                  <form method="post" action="{% url 'delete_lookup' block.model_name item.id %}" class="m-0">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                  </form>
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted">There is no record</div>
        {% endif %}
      </div>
    </div>
  {% endfor %}
</div>

<!-- EDIT Modal -->
<div class="modal fade" id="editLookupModal" tabindex="-1" aria-labelledby="editLookupModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content shadow">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="editLookupModalLabel">Edit Lookup</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body">
        <form id="editLookupForm" method="post" action="#">
          {% csrf_token %}

          
          <div class="mb-3" id="groupField1">
            <label for="editLookupField1" class="form-label">Field 1</label>
            <input type="text" id="editLookupField1" class="form-control">
          </div>

          <div class="mb-3 d-none" id="groupField2">
            <label for="editLookupField2" class="form-label">Field 2</label>
            <input type="text" id="editLookupField2" class="form-control">
          </div>

          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const STORAGE_KEY = 'lookup_accordion_states';
  const SUBMIT_FLAG_KEY = 'lookup_form_submitted';

  // Form submit edildiğinde flag set et
  function setFormSubmitFlag() {
    sessionStorage.setItem(SUBMIT_FLAG_KEY, 'true');
  }

  // Sayfa yüklenirken kontrolü yap
  function shouldClearStorage() {
    const navEntries = performance.getEntriesByType('navigation');
    const isFormSubmit = sessionStorage.getItem(SUBMIT_FLAG_KEY) === 'true';
    
    // Form submit flag'ini temizle
    sessionStorage.removeItem(SUBMIT_FLAG_KEY);
    
    // Eğer form submit değilse storage'ı temizle
    // (manuel refresh, başka sayfadan gelme, vb.)
    return !isFormSubmit;
  }

  // Storage'ı temizle gerekirse
  if (shouldClearStorage()) {
    sessionStorage.removeItem(STORAGE_KEY);
  }

  // Durumu sessionStorage'a kaydet
  function saveState() {
    const states = {};
    document.querySelectorAll('.toggle-header').forEach(header => {
      const sectionName = header.dataset.section;
      const body = header.nextElementSibling;
      states[sectionName] = !body.classList.contains('d-none');
    });
    sessionStorage.setItem(STORAGE_KEY, JSON.stringify(states));
  }

  // Durumu sessionStorage'dan yükle
  function loadState() {
    const savedStates = sessionStorage.getItem(STORAGE_KEY);
    if (savedStates) {
      return JSON.parse(savedStates);
    }
    return {};
  }

  // Accordion başlat
  const toggles = document.querySelectorAll('.toggle-header');
  const toggleAllBtn = document.getElementById('toggle-all');
  const savedStates = loadState();

  toggles.forEach(header => {
    const body = header.nextElementSibling;
    const icon = header.querySelector('.toggle-icon');
    const sectionName = header.dataset.section;

    // Kaydedilmiş durum varsa onu uygula, yoksa kapalı başlat
    if (savedStates[sectionName]) {
      body.classList.remove('d-none');
      icon.textContent = '▲';
    } else {
      body.classList.add('d-none');
      icon.textContent = '▼';
    }

    // Tıklama eventi
    header.addEventListener('click', () => {
      const isOpen = !body.classList.contains('d-none');
      body.classList.toggle('d-none');
      icon.textContent = isOpen ? '▼' : '▲';
      saveState();
      updateToggleAllButton();
    });
  });

  function anyOpen() {
    return Array.from(toggles).some(h => !h.nextElementSibling.classList.contains('d-none'));
  }

  function updateToggleAllButton() {
    toggleAllBtn.textContent = anyOpen() ? 'Collapse all' : 'Expand all';
  }

  toggleAllBtn.addEventListener('click', () => {
    const shouldOpen = !anyOpen();
    toggles.forEach(header => {
      const body = header.nextElementSibling;
      const icon = header.querySelector('.toggle-icon');
      if (shouldOpen) {
        body.classList.remove('d-none');
        icon.textContent = '▲';
      } else {
        body.classList.add('d-none');
        icon.textContent = '▼';
      }
    });
    saveState();
    updateToggleAllButton();
  });

  updateToggleAllButton();

  // Form submit edilmeden önce flag set et ve durumu kaydet
  document.querySelectorAll('form').forEach(form => {
    form.addEventListener('submit', function() {
      setFormSubmitFlag();
      saveState();
    });
  });

  // ===== Edit modal logic =====
  const editForm   = document.getElementById('editLookupForm');
  const field1Wrap = document.getElementById('groupField1');
  const field2Wrap = document.getElementById('groupField2');
  const input1     = document.getElementById('editLookupField1');
  const input2     = document.getElementById('editLookupField2');

  document.querySelectorAll('.open-edit-modal').forEach(btn => {
    btn.addEventListener('click', function () {
      const updateUrl = this.dataset.updateUrl;
      const prefix    = this.dataset.prefix;
      const field1    = this.dataset.field1;
      const field2    = this.dataset.field2;
      const value1    = this.dataset.value1 || '';
      const value2    = this.dataset.value2 || '';

      editForm.setAttribute('action', updateUrl);

      input1.value = value1;
      input1.setAttribute('name', `${prefix}-${field1}`);
      field1Wrap.querySelector('label').textContent = (field1 || 'Field 1').replace(/_/g, ' ');

      if (field2) {
        input2.value = value2;
        input2.setAttribute('name', `${prefix}-${field2}`);
        field2Wrap.classList.remove('d-none');
        field2Wrap.querySelector('label').textContent = field2.replace(/_/g, ' ');
      } else {
        input2.value = '';
        input2.removeAttribute('name');
        field2Wrap.classList.add('d-none');
      }
    });
  });
});
</script>
{% endblock %}